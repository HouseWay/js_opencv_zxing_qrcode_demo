<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>camera + OpenCV + ZXing Demo</title>
    <style>
        video,
        canvas {
            width: 320px;
            height: 240px;
            border: 1px solid #ccc;
            margin: 5px;
            display: block;
        }
    </style>
</head>

<body>
    <h3>摄像头条码识别演示</h3>
    <p id="status">OpenCV.js is loading...</p>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvasOutput"></canvas>
    <p>识别结果: <span id="result">无</span></p>

    <!-- opencv.js CDN -->
    <script async src="https://docs.opencv.org/4.12.0/opencv.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/browser@latest"></script>

    <!-- zxing-js/browser CDN -->
    <script type="text/javascript">


        let video = document.getElementById('video');
        let canvasOutput = document.getElementById('canvasOutput');
        let resultSpan = document.getElementById('result');

        let cap; // OpenCV VideoCapture
        let streaming = false;
        let img;
        function test() {
            if (!cap) return
            const FPS = 30;
            function processVideo() {
                try {
                    if (!streaming) {
                        // clean and stop.
                        img.delete();
                        return;
                    }
                    let begin = Date.now();

                    // start processing.
                    img = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                    cap.read(img);

                    cv.cvtColor(img, img, cv.COLOR_RGB2GRAY)

                    // 显示预处理画面
                    cv.imshow('canvasOutput', img);


                    // 将canvas转换为图像数据供 zxing 识别
                    canvasOutput.toBlob(async (blob) => {
                        if (!blob) return;
                        // 用zxing识别DataMatrix
                        try {
                            const codeReader = new ZXingBrowser.BrowserMultiFormatReader();


                            const resultEl = document.getElementsByClassName('result')[0];

                            const result = await codeReader.decodeFromCanvas(canvasOutput)
                            resultSpan.textContent = result.text;
                            alert(result.text)
                        } catch (err) {
                            resultSpan.textContent = err;
                        }
                        img.delete();
                    });


                    // schedule the next one.
                    let delay = 1000 / FPS - (Date.now() - begin);
                    setTimeout(processVideo, delay);
                } catch (err) {
                    alert(err);
                }
            }

            // schedule the first one.
            setTimeout(processVideo, 0);

        }

        // 访问摄像头
        let contraints = { video: { width: 240, height: 320, facingMode: { exact: "environment" } } }
        navigator.mediaDevices.getUserMedia(contraints)
            .then(function (stream) {
                video.srcObject = stream;
                video.play();
                streaming = true;

                video.addEventListener('loadedmetadata', () => {
                    video.height = video.videoHeight;
                    video.width = video.videoWidth;
                    cap = new cv.VideoCapture(video);
                    test()
                })
            })
            .catch(function (err) {
                // alert('无法访问摄像头: ' + err);
            });

        var Module = {
            // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
            onRuntimeInitialized() {
                document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
                console.log('OpenCV.js is ready.')
            }
        }
    </script>
</body>

</html>